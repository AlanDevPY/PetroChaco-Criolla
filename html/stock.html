<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0f2027">
    <title>Gestión de Stock</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <!-- DataTables Bootstrap 5 -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">

    <!-- Toastify CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!-- Estilos propios -->
    <link rel="stylesheet" href="../css/roles.css">
    <link rel="stylesheet" href="../css/stock-modern.css">
</head>

<body class="d-flex flex-column min-vh-100">

    <!-- Fondo animado -->
    <div class="bg-animated" aria-hidden="true">
        <span class="blob blob-1"></span>
        <span class="blob blob-2"></span>
        <span class="blob blob-3"></span>
    </div>

    <!-- Navbar parcial -->
    <div id="navbar-placeholder"></div>

    <!-- Contenido principal -->
    <main class="container py-4">
        <div
            class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3 animate__animated animate__fadeInDown">
            <h3 class="fw-bold mb-0">
                <i class="bi bi-box-seam me-2"></i>Gestión de Stock
            </h3>

            <div class="d-flex gap-2">
                <input type="text" id="buscarProducto" class="form-control" placeholder="Buscar producto..."
                    autocomplete="off" style="min-width: 250px;">
                <button class="btn btn-primary solo-admin" id="btnAgregar" data-bs-toggle="modal"
                    data-bs-target="#modalAgregarProducto">
                    <i class="bi bi-plus-circle me-1"></i> Agregar Producto
                </button>
            </div>
        </div>

        <!-- Reposición / Nota de Reposición (solo admin) -->
        <div class="card mb-4 solo-admin animate__animated animate__fadeInUp">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-semibold">
                    <i class="bi bi-file-earmark-text me-2"></i>Nota de Reposición
                </span>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" id="btnNuevaNota" data-bs-toggle="collapse"
                        data-bs-target="#reposicionPanel">
                        <i class="bi bi-pencil-square me-1"></i>Armar Nota
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="btnVerHistorial" data-bs-toggle="modal"
                        data-bs-target="#modalHistorialReposiciones">
                        <i class="bi bi-clock-history me-1"></i>Historial
                    </button>
                </div>
            </div>
            <div class="collapse" id="reposicionPanel">
                <div class="card-body">
                    <form id="formAgregarItemReposicion" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Producto</label>
                            <div class="position-relative">
                                <input type="text" class="form-control autocomplete-input" id="reposicionProducto"
                                    placeholder="Buscar producto..." autocomplete="off" required>
                                <i class="bi bi-search position-absolute"
                                    style="right: 1rem; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,.5); pointer-events: none;"></i>
                            </div>
                            <!-- Datalist oculto para datos -->
                            <datalist id="listaProductosReposicion" style="display: none;"></datalist>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Cantidad</label>
                            <input type="number" min="1" class="form-control" id="reposicionCantidad" value="1"
                                required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Precio Compra</label>
                            <input type="text" class="form-control text-end" id="reposicionPrecioCompra" placeholder="0"
                                autocomplete="off">
                            <small class="text-muted">Opcional</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Precio Venta</label>
                            <input type="text" class="form-control text-end" id="reposicionPrecioVenta" placeholder="0"
                                autocomplete="off">
                            <small class="text-muted">Opcional</small>
                        </div>
                        <div class="col-md-2 text-end">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-plus-lg me-1"></i>Agregar
                            </button>
                        </div>
                    </form>
                    <hr>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cant.</th>
                                    <th class="text-end">Precio Compra</th>
                                    <th class="text-end">Precio Venta</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="reposicionTable"></tbody>

                        </table>
                    </div>
                    <div class="text-end mt-2">
                        <button class="btn btn-primary" id="btnConfirmarReposicion" disabled>
                            <i class="bi bi-check-circle me-1"></i>Confirmar Reposición
                        </button>
                        <button class="btn btn-outline-danger" id="btnCancelarReposicion" disabled>
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de productos -->
        <div class="table-responsive animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
            <table class="table table-hover align-middle" id="stockDataTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Producto</th>
                        <th>Categoría</th>
                        <th>Código de Barra</th>
                        <th class="text-center">Stock</th>
                        <th class="text-end">Precio Compra</th>
                        <th class="text-end">Precio Venta</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="stockTable">
                </tbody>
            </table>
        </div>

        <!-- Controles de Paginación -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <small class="text-muted" id="infoPaginacion">Mostrando 0 de 0 productos</small>
            </div>
            <nav aria-label="Paginación de productos">
                <ul class="pagination pagination-sm mb-0" id="paginacionControles">
                    <!-- Se generará dinámicamente -->
                </ul>
            </nav>
        </div>
    </main>

    <!-- Modal Historial Reposiciones -->
    <div class="modal fade" id="modalHistorialReposiciones" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title">Historial de Notas de Reposición</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Usuario</th>
                                    <th>Items</th>
                                    <th>Total Compra</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historialReposicionesTable"></tbody>
                        </table>
                    </div>
                    <small class="text-muted">Se muestran las últimas 50 reposiciones.</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Producto -->
    <div class="modal fade" id="modalAgregarProducto" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Agregar Producto</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registrarStockForm">
                        <div class="mb-3">
                            <label class="form-label">Nombre del Producto</label>
                            <input type="text" id="nuevoItemStock" class="form-control"
                                placeholder="Ej: Lomito Completo" required autocomplete="off">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Categoría</label>
                            <select class="form-select" required id="nuevoCategoriaStock">
                                <option>Comida</option>
                                <option>Bebida</option>
                                <option>Postres</option>
                                <option>Helados</option>
                                <option>Dulces / Bombones</option>
                                <option>Snacks</option>
                                <option>Combos</option>
                                <option>Promociones</option>
                                <option>Insumos / Materia Prima</option>
                                <option>Utensilios / Equipamiento</option>
                                <option>Otros</option>
                            </select>

                        </div>

                        <div class="mb-3">
                            <label class="form-label">Stock</label>
                            <input type="number" id="nuevoCantidadStock" required class="form-control text-center"
                                placeholder="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Precio Compra</label>
                            <input type="text" value="0" autocomplete="off" required id="nuevoPrecioCompraStock"
                                class="form-control text-end" placeholder="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Precio Venta</label>
                            <input type="text" value="0" autocomplete="off" required id="nuevoCostoStock"
                                class="form-control text-end" placeholder="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Código de Barra</label>
                            <input type="number" id="nuevoCodigoBarraStock" class="form-control"
                                placeholder="Tickear codigo de barra aqui!!" required autocomplete="off">
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success" data-bs-dismiss="modal">Agregar</button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>


    <!-- Modal actualizar Producto -->
    <div class="modal fade" id="modalActualizarProducto" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Actualizar Producto <span
                            class="badge rounded-pill bg-warning text-dark ms-2">Solo precio de venta</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="actualizarStockForm">
                        <div class="mb-3">
                            <label class="form-label">Nombre del Producto</label>
                            <input type="text" id="actualizarItemStock" class="form-control"
                                placeholder="Ej: Lomito Completo" required autocomplete="off" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Categoría</label>
                            <select class="form-select" required id="actualizarCategoriaStock" disabled>
                                <option>Comida</option>
                                <option>Bebida</option>
                                <option>Postres</option>
                                <option>Helados</option>
                                <option>Dulces / Bombones</option>
                                <option>Snacks</option>
                                <option>Combos</option>
                                <option>Promociones</option>
                                <option>Insumos / Materia Prima</option>
                                <option>Utensilios / Equipamiento</option>
                                <option>Otros</option>
                            </select>
                        </div>

                        <!-- Campo de Stock removido: la cantidad se gestiona desde reposición/otras acciones -->

                        <div class="mb-3">
                            <label class="form-label">Precio Compra</label>
                            <input type="text" value="0" autocomplete="off" required id="actualizarPrecioCompraStock"
                                class="form-control text-end" placeholder="0" disabled>
                            <small class="text-muted">Solo modifique precios en este modal.</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Precio Venta</label>
                            <input type="text" autocomplete="off" required id="actualizarCostoStock"
                                class="form-control text-end" placeholder="0">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Código de Barra</label>
                            <input type="number" id="actualizarCodigoBarraStock" class="form-control"
                                placeholder="Tickear codigo de barra aqui!!" required autocomplete="off" readonly>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success" data-bs-dismiss="modal">Actualizar</button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white text-center py-3 mt-auto">
        <small>© 2025 Todos los derechos reservados | Creado por <strong>AlanDevPy</strong></small>
    </footer>

    <!-- jQuery (requerido para DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Toastify JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Day.js -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

    <script type="module" src="../js/navbar.js"></script>

    <!-- Custom JS -->
    <script type="module" src="../js/stock.js"></script>

    <!-- Cache Debug (solo en desarrollo) -->
    <script type="module" src="../js/cache-debug.js"></script>
</body>

</html>